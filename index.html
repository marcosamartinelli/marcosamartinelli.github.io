<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel do Reservat√≥rio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
<script>
  const senhaCorreta = "montecristo";
  const chaveSenha = "senha_ok";

  if (localStorage.getItem(chaveSenha) !== "sim") {
    const entrada = prompt("Digite a senha para acesso:");
    if (entrada !== senhaCorreta) {
      // Cria uma camada de bloqueio que cobre toda a p√°gina
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100vw';
      overlay.style.height = '100vh';
      overlay.style.backgroundColor = 'white';
      overlay.style.zIndex = '9999';
      overlay.style.display = 'flex';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      overlay.innerHTML = "<h1 style='color:red; font-size: 2rem;'>üîí Acesso negado</h1>";
      document.body.innerHTML = ''; // Limpa qualquer conte√∫do que j√° tenha carregado
      document.body.appendChild(overlay);
      throw new Error("Senha incorreta");
    }
    localStorage.setItem(chaveSenha, "sim");
  }
</script>

</head>


<body class="bg-light">
<div class="container py-4">
  <div class="text-center mb-4">
    <h2 class="text-primary">Painel Remoto do Reservat√≥rio</h2>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>N√≠vel da √°gua:</strong> <span id="nivel">--</span>%</p>
      <p><strong>Dist√¢ncia:</strong> <span id="distancia">--</span>‚ÄØcm</p>
      <p><strong>Hor√°rio:</strong> <span id="hora">--:--:--</span></p>
      <p><strong>IP Local do ESP32:</strong> <span id="esp-ip">--</span></p>
    </div>
  </div>

  <div class="card mb-3"><div class="card-body">
    <h5>N√≠vel da √Ågua (%)</h5>
    <canvas id="graficoNivel"></canvas>
  </div></div>

  <div class="card mb-3"><div class="card-body">
    <h5>Dist√¢ncia (cm)</h5>
    <canvas id="graficoDist"></canvas>
  </div></div>

  <div class="card mb-3"><div class="card-body">
    <h5>M√©dia M√≥vel do N√≠vel da √Ågua (√∫ltimos 5)</h5>
    <canvas id="graficoMedia"></canvas>
  </div></div>

  <div class="text-end mb-3">
    <button id="baixarCsv" class="btn btn-outline-primary btn-sm">Exportar CSV</button>
    <a href="detalhes.html" class="btn btn-outline-secondary btn-sm">P√°gina de Detalhes</a>
  </div>
</div>

<script>
const channelID = '2992975';
const readAPIKey = '54I7YWRQZ7EKSZKH';
let dadosFeed = [];

let chartNivel, chartDist, chartMedia;

async function carregarDados() {
  const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=20&api_key=${readAPIKey}`;
  const resp = await fetch(url);
  const json = await resp.json();
  const feeds = json.feeds.map(f => ({
    time: f.field3 || f.created_at.substr(11,8),
    nivel: parseFloat(f.field1),
    dist: parseFloat(f.field2),
    ip: f.field4
  }));
  dadosFeed = feeds;

  const ultimo = feeds.at(-1);
  document.getElementById('nivel').innerText = ultimo.nivel;
  document.getElementById('distancia').innerText = ultimo.dist;
  document.getElementById('hora').innerText = ultimo.time;
  document.getElementById('esp-ip').innerText = ultimo.ip || 'N/A';

  const labels = feeds.map(f => f.time);
  const dataNivel = feeds.map(f => f.nivel);
  const dataDist = feeds.map(f => f.dist);
  const dataMedia = feeds.map((_, i, arr) => {
    if (i < 4) return null;
    const slice = arr.slice(i-4, i+1).map(f => f.nivel);
    return (slice.reduce((a,b) => a+b, 0) / 5).toFixed(1);
  });

  if (!chartNivel) {
    chartNivel = new Chart(document.getElementById('graficoNivel'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'N√≠vel (%)', data: dataNivel, borderColor: 'blue', tension: 0.1 }]
      },
      options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
    });
    chartDist = new Chart(document.getElementById('graficoDist'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'Dist√¢ncia (cm)', data: dataDist, borderColor: 'green', tension: 0.1 }]
      },
      options: { responsive: true, scales: { y: { min: 0, max: 260 } } }
    });
    chartMedia = new Chart(document.getElementById('graficoMedia'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'M√©dia M√≥vel (%)', data: dataMedia, borderColor: 'orange', tension: 0.3 }]
      },
      options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
    });
  } else {
    chartNivel.data.labels = labels;
    chartNivel.data.datasets[0].data = dataNivel;
    chartNivel.update();

    chartDist.data.labels = labels;
    chartDist.data.datasets[0].data = dataDist;
    chartDist.update();

    chartMedia.data.labels = labels;
    chartMedia.data.datasets[0].data = dataMedia;
    chartMedia.update();
  }
}

// CSV
document.getElementById('baixarCsv').onclick = () => {
  let csv = "hora,nivel,distancia,ip\n";
  dadosFeed.forEach(f => csv += `${f.time},${f.nivel},${f.dist},${f.ip}\n`);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `nivel_agua_${Date.now()}.csv`;
  a.click();
};

carregarDados();
setInterval(carregarDados, 15000);
</script>
</body>
</html>
