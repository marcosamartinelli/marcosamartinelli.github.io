<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel do Reservatório</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<script>
if (prompt("Digite a senha para acesso:") !== "esp32senha") {
  document.write("<h3>Acesso negado</h3>");
  throw new Error("Senha incorreta");
}
</script>

<div class="container py-4">
  <div class="text-center mb-4">
    <h2 class="text-primary">Painel Remoto do Reservatório</h2>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>Nível da água:</strong> <span id="nivel">--</span>%</p>
      <p><strong>Distância:</strong> <span id="distancia">--</span> cm</p>
      <p><strong>Horário:</strong> <span id="hora">--:--:--</span></p>
    </div>
  </div>

  <div class="card mb-3"><div class="card-body">
    <h5>Nível da Água (%)</h5>
    <canvas id="graficoNivel"></canvas>
  </div></div>

  <div class="card mb-3"><div class="card-body">
    <h5>Distância (cm)</h5>
    <canvas id="graficoDist"></canvas>
  </div></div>

  <div class="card mb-3"><div class="card-body">
    <h5>Média Móvel do Nível da Água (últimos 5)</h5>
    <canvas id="graficoMedia"></canvas>
  </div></div>

  <div class="text-end mb-3">
    <button id="baixarCsv" class="btn btn-outline-primary btn-sm">Exportar CSV</button>
    <a href="detalhes.html" class="btn btn-outline-secondary btn-sm">Página de Detalhes</a>
  </div>
</div>

<script>
const channelID = '2992975';
const readAPIKey = '54I7YWRQZ7EKSZKH';
let dadosFeed = [];

let chartNivel, chartDist, chartMedia;

async function carregarDados() {
  const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=20&api_key=${readAPIKey}`;
  const resp = await fetch(url);
  const json = await resp.json();
  const feeds = json.feeds.map(f => ({
    time: f.field3 || f.created_at.substr(11,8),
    nivel: parseFloat(f.field1),
    dist: parseFloat(f.field2)
  }));
  dadosFeed = feeds;

  const ultimo = feeds.at(-1);
  document.getElementById('nivel').innerText = ultimo.nivel;
  document.getElementById('distancia').innerText = ultimo.dist;
  document.getElementById('hora').innerText = ultimo.time;

  const labels = feeds.map(f => f.time);
  const dataNivel = feeds.map(f => f.nivel);
  const dataDist = feeds.map(f => f.dist);
  const dataMedia = feeds.map((_, i, arr) => {
    if (i < 4) return null;
    const slice = arr.slice(i-4, i+1).map(f => f.nivel);
    return (slice.reduce((a,b) => a+b, 0) / 5).toFixed(1);
  });

  if (!chartNivel) {
    chartNivel = new Chart(document.getElementById('graficoNivel'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'Nível (%)', data: dataNivel, borderColor: 'blue', tension: 0.1 }]
      },
      options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
    });
    chartDist = new Chart(document.getElementById('graficoDist'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'Distância (cm)', data: dataDist, borderColor: 'green', tension: 0.1 }]
      },
      options: { responsive: true, scales: { y: { min: 0, max: 260 } } }
    });
    chartMedia = new Chart(document.getElementById('graficoMedia'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'Média Móvel (%)', data: dataMedia, borderColor: 'orange', tension: 0.3 }]
      },
      options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
    });
  } else {
    chartNivel.data.labels = labels;
    chartNivel.data.datasets[0].data = dataNivel;
    chartNivel.update();

    chartDist.data.labels = labels;
    chartDist.data.datasets[0].data = dataDist;
    chartDist.update();

    chartMedia.data.labels = labels;
    chartMedia.data.datasets[0].data = dataMedia;
    chartMedia.update();
  }
}

// CSV
document.getElementById('baixarCsv').onclick = () => {
  let csv = "hora,nivel,distancia\n";
  dadosFeed.forEach(f => csv += `${f.time},${f.nivel},${f.dist}\n`);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `nivel_agua_${Date.now()}.csv`;
  a.click();
};

carregarDados();
setInterval(carregarDados, 15000);
</script>
</body>
</html>
